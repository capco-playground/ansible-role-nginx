---
- name: Find exist conf file in NGINX.
  find:
    paths: "{{ nginx_proxy_target_path }}"
    file_type: "file"
    patterns: "*.conf"
  register: conf_files

- name: Ensure backup dir is existed.
  file:
    path: "{{ nginx_proxy_remove_exist_conf_backup_path }}/{{ '%d%m%Y' | strftime }}"
    state: directory
    mode: '0755'
    owner: "{{ customize_owner_user }}"
    group: "{{ customize_owner_group }}"
  become: true
  become_user: root
  register: backup_dir_by_date
  when: nginx_proxy_remove_exist_conf_backup_enabled | bool

- name: Backup file to other.
  copy:
    src: "{{ item }}"
    dest: "{{ backup_dir_by_date.path }}"
    owner: "{{ customize_owner_user }}"
    group: "{{ customize_owner_group }}"
    remote_src: true
  become: true
  become_user: "{{ customize_owner_user }}"
  with_items: "{{ conf_files.files | map(attribute='path') | list }}"
  when: nginx_proxy_remove_exist_conf_backup_enabled | bool

- name: Remove conf files.
  file:
    path: "{{ item }}"
    state: 'absent'
  become: true
  become_user: "{{ customize_owner_user }}"
  with_items: "{{ conf_files.files | map(attribute='path') | list }}"
